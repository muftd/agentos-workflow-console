# Workflow Console · v0.2 开发计划

> **状态**: 🚀 开发中
>
> **开始时间**: 2025-11-18
>
> **目标**: 从"单一演示"到"实用工具"

## 1. 需求确认

### 用户决策（2025-11-18）

**Q1: 数据持久化方案**
- ✅ 采用 LocalStorage
- ❌ 不需要导入/导出功能
- 理由：最轻量简单，v0.2 保持纯前端

**Q2: 编辑功能范围**
- ✅ 最小版本：基础表单 + 简单验证 + 保存/取消
- ❌ 不需要撤销/重做、实时预览等高级功能
- 理由：用户只有一人，简单验证即可

**Q3: Session 切换 UI**
- ✅ 侧边栏抽屉（Sidebar Drawer）
- 理由：符合现代应用习惯，不占主界面空间

**Q4: 撤销/重做**
- ❌ v0.2 不做
- 理由：用确认对话框防误操作即可

### 最终需求范围（P0 Only）

v0.2 **只实现** P0 核心功能：

1. ✅ 多 Session 管理基础
   - Session 列表（侧边栏）
   - Session 切换
   - 按创建日期排序

2. ✅ 数据持久化（LocalStorage）
   - CRUD 接口封装
   - 自动保存机制

3. ✅ Session 编辑功能
   - 新建 session（基础表单）
   - 编辑 session 元数据
   - 删除 session（带确认）
   - 复制 session

4. ✅ Step 编辑功能
   - 新建 step（基础表单）
   - 编辑现有 step
   - 删除 step（带确认）

**不做**（延后到 v0.3+）：
- ❌ Session 元数据增强（tags/status/priority）
- ❌ 导入/导出功能
- ❌ 搜索和过滤
- ❌ 撤销/重做
- ❌ Step 排序调整（拖拽）

## 2. 开发阶段

### Stage 1: 数据层重构 (2-3天)

**目标**: 建立 LocalStorage 数据存储和管理能力

#### 任务清单

- [ ] 设计 LocalStorage 数据结构
  ```typescript
  interface AppData {
    version: '0.2';
    sessions: WorkflowSession[];
    currentSessionId: string | null;
    lastUpdated: string;
  }
  ```

- [ ] 实现 WorkflowStorage 封装类
  - `load()` - 加载所有数据
  - `save()` - 保存所有数据
  - `getSessions()` - 获取所有 sessions
  - `getSession(id)` - 获取单个 session
  - `addSession(session)` - 新建 session
  - `updateSession(id, updates)` - 更新 session
  - `deleteSession(id)` - 删除 session
  - `addStep(sessionId, step)` - 新建 step
  - `updateStep(sessionId, stepId, updates)` - 更新 step
  - `deleteStep(sessionId, stepId)` - 删除 step

- [ ] 数据迁移逻辑
  - 检测是否首次使用
  - 从 `/data/workflow-log-sample.json` 加载初始数据
  - 保存到 LocalStorage

- [ ] 单元测试
  - CRUD 操作正确性
  - 数据持久化验证
  - 边界情况处理

**成功标准**:
- LocalStorage 读写正常
- 数据迁移自动完成
- 所有 CRUD 操作通过测试

### Stage 2: 状态管理重构 (1-2天)

**目标**: 用 React Context 管理全局状态

#### 任务清单

- [ ] 创建 AppContext
  ```typescript
  interface AppState {
    sessions: WorkflowSession[];
    currentSessionId: string | null;
    isEditMode: boolean;
    isSidebarOpen: boolean;
  }
  ```

- [ ] 实现 AppReducer
  - `SET_SESSIONS` - 设置所有 sessions
  - `SELECT_SESSION` - 选择当前 session
  - `ADD_SESSION` - 添加 session
  - `UPDATE_SESSION` - 更新 session
  - `DELETE_SESSION` - 删除 session
  - `ADD_STEP` - 添加 step
  - `UPDATE_STEP` - 更新 step
  - `DELETE_STEP` - 删除 step
  - `TOGGLE_EDIT_MODE` - 切换编辑模式
  - `TOGGLE_SIDEBAR` - 切换侧边栏

- [ ] 创建自定义 Hook
  - `useApp()` - 访问 AppContext
  - `useSessions()` - 获取 sessions 列表
  - `useCurrentSession()` - 获取当前 session

**成功标准**:
- 状态管理逻辑清晰
- 组件间数据流通畅
- 无不必要的重渲染

### Stage 3: Session 列表 UI (1-2天)

**目标**: 实现侧边栏抽屉，展示 session 列表

#### 任务清单

- [ ] 创建 Sidebar 组件
  - 使用 shadcn Sheet 组件
  - 响应式设计（移动端全屏，桌面端固定宽度）

- [ ] 创建 SessionList 组件
  - 渲染所有 sessions
  - 按创建日期降序排序
  - 高亮当前 session

- [ ] 创建 SessionListItem 组件
  - 显示标题、日期、步骤数
  - 点击切换 session
  - hover 效果

- [ ] 集成到 WorkflowConsolePage
  - 添加菜单触发按钮
  - 侧边栏打开/关闭动画

**成功标准**:
- 侧边栏滑动流畅
- Session 列表正确显示
- 切换 session 无延迟

### Stage 4: Session 编辑功能 (2-3天)

**目标**: 实现 session 的新建、编辑、删除、复制

#### 任务清单

- [ ] 创建 SessionFormDialog 组件
  - Title 输入框（必填，1-100 字符）
  - Description 文本域（必填，1-500 字符）
  - 保存/取消按钮
  - 客户端表单验证

- [ ] 新建 Session 功能
  - 侧边栏 "+ New Session" 按钮
  - 打开 SessionFormDialog
  - 生成唯一 session_id（UUID）
  - 创建时间自动生成
  - 保存到 LocalStorage

- [ ] 编辑 Session 功能
  - SessionListItem 右侧编辑图标
  - 打开 SessionFormDialog（预填数据）
  - 更新 LocalStorage

- [ ] 删除 Session 功能
  - SessionListItem 右侧删除图标
  - 确认对话框（"确定删除 {title}?"）
  - 从 LocalStorage 删除
  - 如果删除的是当前 session，自动切换到第一个

- [ ] 复制 Session 功能
  - SessionListItem 右侧复制图标
  - 复制所有数据，重新生成 ID
  - 标题添加 "(Copy)" 后缀
  - 保存到 LocalStorage

**成功标准**:
- 所有表单操作流畅
- 验证提示清晰
- 数据持久化正确

### Stage 5: Step 编辑功能 (2-3天)

**目标**: 实现 step 的新建、编辑、删除

#### 任务清单

- [ ] 创建 StepFormDialog 组件
  - Actor 输入框（必填）
  - Tool 输入框（必填）
  - Skill 输入框（可选）
  - Input Label 文本域（必填）
  - Output Label 文本域（必填）
  - Summary 文本域（可选）
  - 保存/取消按钮

- [ ] 修改 StepNode 组件
  - 编辑模式下显示编辑/删除按钮
  - 点击编辑打开 StepFormDialog

- [ ] 修改 FlowMap 组件
  - 编辑模式下显示 "+ Add Step" 按钮
  - 点击新建打开 StepFormDialog

- [ ] 新建 Step 功能
  - 生成唯一 step_id（UUID）
  - 自动计算 order（最大 order + 1）
  - Timestamp 自动生成
  - 保存到 LocalStorage

- [ ] 编辑 Step 功能
  - 打开 StepFormDialog（预填数据）
  - 更新 LocalStorage

- [ ] 删除 Step 功能
  - 确认对话框
  - 从 LocalStorage 删除
  - 重新计算剩余 steps 的 order

**成功标准**:
- 编辑模式切换流畅
- Step CRUD 操作正确
- UI 反馈及时

### Stage 6: 优化和测试 (1-2天)

**目标**: 打磨用户体验，全面测试

#### 任务清单

- [ ] UI/UX 优化
  - 加载状态提示
  - 错误提示优化
  - 空状态友好提示（首次使用引导）
  - 编辑模式切换提示

- [ ] 性能优化
  - LocalStorage 读写优化
  - 组件渲染优化（React.memo）
  - 列表虚拟化（如果 sessions 很多）

- [ ] 全面测试
  - 新建/编辑/删除 sessions
  - 新建/编辑/删除 steps
  - Session 切换
  - 编辑模式切换
  - LocalStorage 持久化
  - 浏览器刷新后数据保留
  - 响应式设计（移动/桌面）

- [ ] 文档更新
  - 更新 README
  - 更新 dev docs（plan/context/task）
  - 记录技术决策

**成功标准**:
- 所有功能正常工作
- 用户体验流畅
- 无明显 bug

## 3. 技术栈

### 新增依赖

```json
{
  "dependencies": {
    "uuid": "^10.0.0"  // 生成唯一 ID
  },
  "devDependencies": {
    "@types/uuid": "^10.0.0"
  }
}
```

### 新增组件

```
client/src/
├── lib/
│   └── storage.ts              // LocalStorage 封装
├── contexts/
│   └── AppContext.tsx          // 全局状态管理
├── components/
│   ├── ui/
│   │   └── sheet.tsx           // shadcn Sheet 组件
│   ├── layout/
│   │   └── Sidebar.tsx         // 侧边栏容器
│   └── session/
│       ├── SessionList.tsx     // Session 列表
│       ├── SessionListItem.tsx // Session 列表项
│       ├── SessionFormDialog.tsx // Session 表单对话框
│       └── StepFormDialog.tsx  // Step 表单对话框
```

## 4. 开发时间估算

| 阶段 | 预计时间 | 说明 |
|------|---------|------|
| Stage 1: 数据层重构 | 2-3天 | 核心基础设施 |
| Stage 2: 状态管理 | 1-2天 | React Context |
| Stage 3: Session 列表 | 1-2天 | 侧边栏 UI |
| Stage 4: Session 编辑 | 2-3天 | CRUD 表单 |
| Stage 5: Step 编辑 | 2-3天 | CRUD 表单 |
| Stage 6: 优化测试 | 1-2天 | 打磨细节 |
| **总计** | **9-15天** | **约 2 周** |

## 5. 成功标准

### 功能标准
- [x] 可以创建、编辑、删除多个 sessions
- [x] 可以在 sessions 之间切换
- [x] 可以编辑 steps（新建、修改、删除）
- [x] 数据可持久化，刷新页面不丢失
- [x] 侧边栏抽屉交互流畅

### 质量标准
- [x] 所有操作有明确的用户反馈
- [x] 表单有客户端验证和错误提示
- [x] 删除操作有确认对话框
- [x] UI 质量保持 Figma/Framer 级别
- [x] 响应式设计在移动端正常工作

### 性能标准
- [x] LocalStorage 读写流畅（< 100ms）
- [x] Session 切换无延迟（< 200ms）
- [x] 支持至少 50 个 sessions

## 6. 风险和注意事项

### 技术风险

1. **LocalStorage 容量限制**
   - 风险：5MB 限制可能不够
   - 缓解：单个 session 通常 < 10KB，50 个 sessions 约 500KB
   - 监控：在接近限制时提示用户

2. **数据丢失风险**
   - 风险：用户清除浏览器数据会丢失所有 sessions
   - 缓解：在首次使用时提示用户
   - 未来：v0.3 考虑导出/备份功能

3. **并发编辑风险**
   - 风险：多个标签页同时编辑
   - 缓解：v0.2 假设单标签页使用
   - 未来：v0.3 使用 localStorage 事件监听

### 开发注意事项

1. **保持 v0.1 UI 质量**
   - 所有新组件遵循现有设计系统
   - 使用相同的 shadow/color/spacing 标准
   - 渐变、动画保持一致

2. **表单验证简单即可**
   - 用户只有一人，不需要复杂验证
   - 必填字段检查
   - 字符长度限制
   - 实时错误提示

3. **确认对话框必须有**
   - 删除 session
   - 删除 step
   - 文案清晰（显示被删除项的标题）

## 7. 下一步行动

### 立即开始

✅ 需求已确认
✅ 计划已制定

🚀 **开始 Stage 1: 数据层重构**

1. 创建 `client/src/lib/storage.ts`
2. 实现 WorkflowStorage 类
3. 实现数据迁移逻辑
4. 编写单元测试

---

**Let's build v0.2!** 🎯
